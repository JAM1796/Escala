<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gift Hub Pages - Escala Médica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react" data-type="module">
    import React, { useState, useEffect, useMemo } from "https://esm.sh/react@18";
    import { createRoot } from "https://esm.sh/react-dom@18/client";
    import {
      Calendar,
      Clock,
      User,
      Users,
      Plus,
      AlertCircle,
      CheckCircle2,
      Search,
      Trash2,
      X,
      ArrowRightLeft,
      Save,
      FileText,
      Phone,
      Filter,
      MoreHorizontal,
      ChevronLeft,
      ChevronRight,
      CalendarDays,
      LayoutGrid,
      DownloadCloud,
      UploadCloud,
      FileSpreadsheet,
      Sparkles,
      Bot,
      MessageSquare,
      Loader2,
      Copy,
      Database,
      Wifi,
      WifiOff,
      Settings,
      ShieldAlert,
      Unlock
    } from "https://esm.sh/lucide-react@0.462.0";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      signInWithCustomToken,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      deleteDoc,
      onSnapshot,
      query
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- ⚠️ CONFIGURAÇÃO REAL DO MUNDO EXTERNO ⚠️ ---
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDcAIe6qMtzclRsvmKzqnNySckT6h0nD1g",
      authDomain: "biocor-escala.firebaseapp.com",
      projectId: "biocor-escala",
      storageBucket: "biocor-escala.firebasestorage.app",
      messagingSenderId: "576006517338",
      appId: "1:576006517338:web:fbfbe3d05cef40a8809e63",
      measurementId: "G-7SSMJ2TH0N"
    };

    const GEMINI_API_KEY = "AIzaSyBfKB6KbbL3W2WZkl9ugPdKdwp74f30at0";

    // Inicialização Robusta do Firebase
    let app, auth, db;
    try {
      // Tenta usar a config do usuário, fallback para ambiente se necessário
      let config = FIREBASE_CONFIG;
      // Se a chave for a padrão do template, tenta usar a do ambiente (apenas para dev)
      if (FIREBASE_CONFIG.apiKey === "SUA_API_KEY_AQUI" && typeof __firebase_config !== "undefined") {
        config = JSON.parse(__firebase_config);
      }
      app = initializeApp(config);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (error) {
      console.error("Erro fatal na inicialização do Firebase:", error);
    }

    const appId = typeof __app_id !== "undefined" ? __app_id : "biocor-pronto-atendimento-v1";

    // --- DADOS PRELIMINARES (CSV DEZEMBRO) ---
    const DECEMBER_DATA_RAW = `2025-12-01,Diurno,Dra. Juliana
2025-12-01,Diurno,Dr. Paulo Vitor
2025-12-01,Horizontal_manha,Dr. Fabiano
2025-12-01,Horizontal_tarde,Dra. Maria Mameluque
2025-12-01,Noturno,Dra. Clara
2025-12-01,Noturno,Dra. Fernanda
2025-12-02,Diurno,Dra. Thaynara
2025-12-02,Diurno,Dr. Felipe
2025-12-02,Horizontal_manha,Dr. Fabiano
2025-12-02,Horizontal_tarde,Dra. Clara
2025-12-02,Noturno,Dra. Gabriela Ourivio
2025-12-02,Noturno,Dra. Cassia Caetano
2025-12-03,Diurno,Dr. Paulo Vitor
2025-12-03,Diurno,Dr. Renan
2025-12-03,Horizontal_manha,Dr. Sérgio
2025-12-03,Horizontal_tarde,Dr. Luiz
2025-12-03,Noturno,Dra. Ana Paula
2025-12-03,Noturno,Dra. Clara
2025-12-04,Diurno,Dra. Patrícia F
2025-12-04,Diurno,Dra. Juliana
2025-12-04,Horizontal_manha,Dr. Sérgio
2025-12-04,Horizontal_tarde,Dr. Luiz
2025-12-04,Noturno,Dr. Wellington
2025-12-04,Noturno,Dr. Felipe
2025-12-05,Diurno,Dra. Bruna
2025-12-05,Diurno,Dr. Sérgio
2025-12-05,Horizontal_manha,Dr. Paulo Vitor
2025-12-05,Horizontal_tarde,Dr. Paulo Vitor
2025-12-05,Noturno,Dra. Larissa
2025-12-05,Noturno,Dr. João Ataide
2025-12-06,Diurno,Dra. Natalia Araujo
2025-12-06,Diurno,Dra. Bruna
2025-12-06,Noturno,Dra. Gabriela Ourivio
2025-12-06,Noturno,Dra. Thaynara
2025-12-07,Diurno,Dra. Natalia Araujo
2025-12-07,Diurno,Dr. Sérgio Diniz
2025-12-07,Noturno,Dra. Fernanda
2025-12-07,Noturno,Dr. Felipe
2025-12-08,Diurno,Dr. Rafael
2025-12-08,Diurno,Dr. Paulo Vitor
2025-12-08,Horizontal_manha,Dr. Fabiano
2025-12-08,Horizontal_tarde,Dra. Clara
2025-12-08,Noturno,Dra. Cassia
2025-12-08,Noturno,Dra. Ana Paula
2025-12-09,Diurno,Dra. Thaynara
2025-12-09,Diurno,Dr. Felipe
2025-12-09,Horizontal_manha,Dr. Fabiano
2025-12-09,Horizontal_tarde,Dra. Clara
2025-12-09,Noturno,Dra. Rafaela
2025-12-09,Noturno,Dra. Cassia Caetano
2025-12-10,Diurno,Dr. Paulo Vitor
2025-12-10,Diurno,Dr. Renan
2025-12-10,Horizontal_manha,Dr. Sérgio
2025-12-10,Horizontal_tarde,Dr. Luiz
2025-12-10,Noturno,Dra. Ana Paula
2025-12-10,Noturno,Dra. Clara
2025-12-11,Diurno,Dra. Patrícia F
2025-12-11,Diurno,Dra. Juliana
2025-12-11,Horizontal_manha,Dr. Sérgio
2025-12-11,Horizontal_tarde,Dr. Luiz
2025-12-11,Noturno,Dra. Fernanda Freire
2025-12-11,Noturno,Dr. Felipe
2025-12-12,Diurno,Dra. Patrícia
2025-12-12,Diurno,Dra. Bruna
2025-12-12,Horizontal_manha,Dr. Paulo Vitor
2025-12-12,Horizontal_tarde,Dr. Paulo Vitor
2025-12-12,Noturno,Dra. Maria Mameluque
2025-12-12,Noturno,Dra. Marina Eto
2025-12-13,Diurno,Dr. Felipe
2025-12-13,Diurno,Dra. Patrícia F
2025-12-13,Noturno,Dra. Gabriela Gois
2025-12-13,Noturno,Dr. Fabiano
2025-12-14,Diurno,Dra. Clara
2025-12-14,Diurno,Dra. Leticia Batista
2025-12-14,Noturno,Dr. Guilherme Paiva
2025-12-14,Noturno,Dra. Juliana
2025-12-15,Diurno,Dr. Rafael Prates
2025-12-15,Diurno,Dr. Paulo Vitor
2025-12-15,Horizontal_manha,Dr. Fabiano
2025-12-15,Horizontal_tarde,Dra. Maria Mameluque
2025-12-15,Noturno,Dra. Fernanda
2025-12-15,Noturno,Dra. Clara
2025-12-16,Diurno,Dra. Thaynara
2025-12-16,Diurno,Dr. Felipe Ferrari
2025-12-16,Horizontal_manha,Dr. Fabiano
2025-12-16,Horizontal_tarde,Dra. Clara
2025-12-16,Noturno,Dra. Gabriela Ourivio
2025-12-16,Noturno,Dra. Cassia
2025-12-17,Diurno,Dr. Paulo Vitor
2025-12-17,Diurno,Dr. Renan
2025-12-17,Horizontal_manha,Dr. Sérgio
2025-12-17,Horizontal_tarde,Dr. Luiz
2025-12-17,Noturno,Dra. Ana Paula
2025-12-17,Noturno,Dra. Clara
2025-12-18,Diurno,Dra. Patrícia
2025-12-18,Diurno,Dra. Juliana
2025-12-18,Horizontal_manha,Dr. Sérgio
2025-12-18,Horizontal_tarde,Dr. Luiz
2025-12-18,Noturno,Dr. Wellington
2025-12-18,Noturno,Dr. Felipe
2025-12-19,Diurno,Dra. Bruna
2025-12-19,Diurno,Dr. Sérgio
2025-12-19,Horizontal_manha,Dr. Paulo Vitor
2025-12-19,Horizontal_tarde,Dr. Paulo Vitor
2025-12-19,Noturno,Dra. Gabriela Rangel
2025-12-19,Noturno,Dra. Juliana
2025-12-20,Diurno,Dr. Renan
2025-12-20,Diurno,Dra. Ana Paula
2025-12-20,Noturno,Dra. Rafaela
2025-12-20,Noturno,Dra. Thaynara
2025-12-21,Diurno,Dra. Ana Paula
2025-12-21,Diurno,Dra. Isabela Nogueira
2025-12-21,Noturno,Dra. Isabela Gomes
2025-12-21,Noturno,Dra. Clara
2025-12-22,Diurno,Dra. Juliana
2025-12-22,Diurno,Dr. Paulo Vitor
2025-12-22,Horizontal_manha,Dr. Fabiano
2025-12-22,Horizontal_tarde,Dra. Clara
2025-12-22,Noturno,Dra. Cassia
2025-12-22,Noturno,Dra. Ana Paula
2025-12-23,Diurno,Dra. Thaynara
2025-12-23,Diurno,Dr. Felipe
2025-12-23,Horizontal_manha,Dr. Fabiano
2025-12-23,Horizontal_tarde,Dra. Clara
2025-12-23,Noturno,Dra. Rafaela
2025-12-23,Noturno,Dra. Cassia Caetano
2025-12-24,Diurno,Dr. Paulo Vitor
2025-12-24,Diurno,Dr. Renan
2025-12-24,Horizontal_manha,Dr. Sérgio
2025-12-24,Horizontal_tarde,Dr. Luiz
2025-12-24,Noturno,Dra. Ana Paula
2025-12-24,Noturno,Dra. Clara
2025-12-25,Diurno,Dra. Patrícia F
2025-12-25,Diurno,Dra. Juliana
2025-12-25,Horizontal_manha,Dr. Sérgio
2025-12-25,Horizontal_tarde,Dr. Luiz
2025-12-25,Noturno,Dra. Fernanda Freire
2025-12-25,Noturno,Dr. Felipe
2025-12-26,Diurno,Dra. Patrícia
2025-12-26,Diurno,Dra. Bruna
2025-12-26,Horizontal_manha,Dr. Paulo Vitor
2025-12-26,Horizontal_tarde,Dr. Paulo Vitor
2025-12-26,Noturno,Dra. Cassia
2025-12-26,Noturno,Dra. Gabriela Gois
2025-12-27,Diurno,Dra. Maria Mameluque
2025-12-27,Diurno,Dra. Daniela Alves
2025-12-27,Noturno,Dra. Isabela Gomes
2025-12-27,Noturno,Dra. Larissa
2025-12-28,Diurno,Dr. Paulo Vitor
2025-12-28,Diurno,Dr. Hugo Duarte
2025-12-28,Noturno,Dra. Cassia Caetano
2025-12-28,Noturno,Dra. Rafaela
2025-12-29,Diurno,Dra. Juliana
2025-12-29,Diurno,Dr. Paulo Vitor
2025-12-29,Horizontal_manha,Dr. Fabiano
2025-12-29,Horizontal_tarde,Dra. Maria Mameluque
2025-12-29,Noturno,Dra. Clara
2025-12-29,Noturno,Dra. Fernanda
2025-12-30,Diurno,Dra. Thaynara
2025-12-30,Diurno,Dr. Felipe
2025-12-30,Horizontal_manha,Dr. Fabiano
2025-12-30,Horizontal_tarde,Dra. Clara
2025-12-30,Noturno,Dra. Gabriela Ourivio
2025-12-30,Noturno,Dra. Cassia Caetano
2025-12-31,Diurno,Dr. Paulo Vitor
2025-12-31,Diurno,Dr. Renan
2025-12-31,Horizontal_manha,Dr. Sérgio
2025-12-31,Horizontal_tarde,Dr. Luiz
2025-12-31,Noturno,Dra. Ana Paula
2025-12-31,Noturno,Dra. Clara`;

    // --- CONFIGURAÇÃO E DADOS ---

    const SHIFT_GROUPS = [
      { id: "g_pa_dia", name: "PA - Diurno", time: "07:00 - 19:00", color: "bg-blue-100 text-blue-700 border-blue-200", dotColor: "bg-blue-500" },
      { id: "g_horizontal", name: "Horizontal (Internação)", time: "09:00 - 21:00", color: "bg-emerald-100 text-emerald-700 border-emerald-200", dotColor: "bg-emerald-500" },
      { id: "g_pa_noite", name: "PA - Noturno", time: "19:00 - 07:00", color: "bg-indigo-100 text-indigo-700 border-indigo-200", dotColor: "bg-indigo-500" }
    ];

    const ROLES = [
      { id: "pa_dia", groupId: "g_pa_dia", name: "Integral (12h)", time: "07:00 - 19:00", required: 2 },
      { id: "pa_dia_manha", groupId: "g_pa_dia", name: "Manhã (6h)", time: "07:00 - 13:00", required: 0 },
      { id: "pa_dia_tarde", groupId: "g_pa_dia", name: "Tarde (6h)", time: "13:00 - 19:00", required: 0 },

      { id: "horizontal", groupId: "g_horizontal", name: "Rotina (12h)", time: "09:00 - 21:00", required: 1 },
      { id: "horizontal_manha", groupId: "g_horizontal", name: "Rotina Manhã (6h)", time: "09:00 - 15:00", required: 0 },
      { id: "horizontal_tarde", groupId: "g_horizontal", name: "Rotina Tarde (6h)", time: "15:00 - 21:00", required: 0 },

      { id: "pa_noite", groupId: "g_pa_noite", name: "Integral (12h)", time: "19:00 - 07:00", required: 2 }
    ];

    // Lista de Médicos Atualizada
    const DOCTORS_MOCK = [
      { id: "renan", name: "Dr. Renan Salgado", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "paulo", name: "Dr. Paulo Victor", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "fabiano", name: "Dr. Fabiano Argeu", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "clara", name: "Dra. Clara Machado", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "sergio_diniz", name: "Dr. Sérgio Diniz", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "luiz", name: "Dr. Luiz", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "maria_m", name: "Dra. Maria Mameluque", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "filipe", name: "Dr. Filipe Ferrari", crm: "CRM-MG", phone: "(31) 9....", specialty: "Horizontal / PA", allowedHorizontal: true },
      { id: "wellington", name: "Dr. Wellington", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "ana_p", name: "Dra. Ana Paula", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "bruna", name: "Dra. Bruna Pimenta", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "cassia", name: "Dra. Cassia Caetano", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "daniela", name: "Dra. Daniela Alves", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "gabriela_g", name: "Dra. Gabriela Góis", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "gabriela_r", name: "Dra. Gabriela Rangel", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "gabriela_o", name: "Dra. Gabriela Ourivio", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "hugo", name: "Dr. Hugo Duarte", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "joao", name: "Dr. João Ataide", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "juliana", name: "Dra. Juliana", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "larissa", name: "Dra. Larissa Mendes", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "marina", name: "Dra. Marina Eto", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "natalia", name: "Dra. Natalia Araujo", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "patricia", name: "Dra. Patrícia", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "rafaela", name: "Dra. Rafaela Vasconcelos", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "thaynara", name: "Dra. Thaynara", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "fernanda", name: "Dra. Fernanda Freire", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "isabela_n", name: "Dra. Isabela Nogueira", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "isabela_g", name: "Dra. Isabela Gomes", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "guilherme", name: "Dr. Guilherme Paiva", crm: "CRM-MG", phone: "(31) 9....", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "leticia", name: "Dra. Leticia Batista", crm: "CRM-MG", phone: "", specialty: "Plantonista PA", allowedHorizontal: false },
      { id: "rafael", name: "Dr. Rafael Prates", crm: "CRM-MG", phone: "", specialty: "Plantonista PA", allowedHorizontal: false }
    ].sort((a, b) => a.name.localeCompare(b.name));

    const TODAY = new Date().toISOString().split("T")[0];

    const StatusBadge = ({ status, compact = false }) => {
      const styles = {
        confirmado: "bg-green-100 text-green-700 border-green-200",
        pendente: "bg-amber-100 text-amber-700 border-amber-200",
        troca: "bg-purple-100 text-purple-700 border-purple-200"
      };
      const labels = {
        confirmado: "OK",
        pendente: "Pendente",
        troca: "Troca"
      };

      if (compact) {
        const dotStyles = {
          confirmado: "bg-green-500",
          pendente: "bg-amber-500",
          troca: "bg-purple-500"
        };
        return <div className={`w-2 h-2 rounded-full ${dotStyles[status] || "bg-slate-300"}`} title={status} />;
      }

      return (
        <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full border ${styles[status] || styles.pendente}`}>
          {labels[status] || status}
        </span>
      );
    };

    function MedicalScaleManager() {
      const [shifts, setShifts] = useState([]);
      const [selectedDate, setSelectedDate] = useState(TODAY);
      const [viewMode, setViewMode] = useState("day");
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isImportModalOpen, setIsImportModalOpen] = useState(false);
      const [isCopilotOpen, setIsCopilotOpen] = useState(false);
      const [selectedShift, setSelectedShift] = useState(null);
      const [toast, setToast] = useState(null);
      const [user, setUser] = useState(null);
      const [authError, setAuthError] = useState(null);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      // Por padrão, se autenticação der erro, entramos em modo "bypass" (assumindo regras públicas)
      const [isAuthBypassed, setIsAuthBypassed] = useState(false);

      // AI State
      const [aiResult, setAiResult] = useState("");
      const [aiLoading, setAiLoading] = useState(false);

      // Form State
      const [selectedGroup, setSelectedGroup] = useState("g_pa_dia");
      const [form, setForm] = useState({
        doctorId: "",
        roleId: "pa_dia",
        date: TODAY,
        status: "confirmado",
        obs: ""
      });

      // Import State
      const [importText, setImportText] = useState("");

      // --- CONNECTIVITY STATUS ---
      useEffect(() => {
        const handleStatusChange = () => setIsOnline(navigator.onLine);
        window.addEventListener("online", handleStatusChange);
        window.addEventListener("offline", handleStatusChange);
        return () => {
          window.removeEventListener("online", handleStatusChange);
          window.removeEventListener("offline", handleStatusChange);
        };
      }, []);

      // --- AUTHENTICATION & SYNC ---
      useEffect(() => {
        const initAuth = async () => {
          try {
            const isUserConfig = FIREBASE_CONFIG.apiKey !== "SUA_API_KEY_AQUI";

            if (isUserConfig) {
              // Tenta login, se falhar (ex: domínio não autorizado), cai no catch
              await signInAnonymously(auth);
            } else if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
            setAuthError(null);
          } catch (err) {
            // ERROR HANDLER: Força modo público para funcionamento
            console.warn("Modo de Autenticação degradado (Bypass Ativo).", err.code);
            setIsAuthBypassed(true);
            // Não mostramos erro para o usuário não se assustar, apenas rodamos sem auth
          }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
          if (u) setIsAuthBypassed(false);
        });
        return () => unsubscribe();
      }, []);

      // --- DATA FETCHING (FIRESTORE) ---
      useEffect(() => {
        // Permite buscar se estiver logado OU se estivermos em modo bypass
        // Isso garante que o snapshot seja criado
        if (!user && !isAuthBypassed) {
          // Tenta mais uma vez ativar o bypass se demorar
          const timer = setTimeout(() => setIsAuthBypassed(true), 2000);
          return () => clearTimeout(timer);
        }

        const q = query(collection(db, "artifacts", appId, "public", "data", "shifts"));

        const unsubscribe = onSnapshot(
          q,
          (snapshot) => {
            const loadedShifts = snapshot.docs.map((doc) => doc.data());
            setShifts(loadedShifts);
          },
          (error) => {
            console.error("Erro de sincronização:", error);
            if (error.code === "permission-denied") {
              setAuthError("permissao");
            }
          }
        );

        return () => unsubscribe();
      }, [user, isAuthBypassed]);

      // --- TOAST TIMER ---
      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);

      // --- HELPERS DE DATA ---
      const getDayOfWeek = (dateString) => {
        const days = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        const date = new Date(dateString + "T12:00:00");
        return days[date.getDay()];
      };

      const isWeekend = (dateString) => {
        const day = new Date(dateString + "T12:00:00").getDay();
        return day === 0 || day === 6;
      };

      const formatDateBR = (dateString) => {
        const [y, m, d] = dateString.split("-");
        return `${d}/${m}`;
      };

      // Navegação
      const handleNav = (direction) => {
        const d = new Date(selectedDate + "T12:00:00");

        if (viewMode === "day") {
          d.setDate(d.getDate() + (direction === "next" ? 1 : -1));
        } else if (viewMode === "week") {
          d.setDate(d.getDate() + (direction === "next" ? 7 : -7));
        } else if (viewMode === "month") {
          d.setMonth(d.getMonth() + (direction === "next" ? 1 : -1));
        }

        setSelectedDate(d.toISOString().split("T")[0]);
      };

      // Ranges
      const getWeekRange = () => {
        const d = new Date(selectedDate + "T12:00:00");
        const day = d.getDay(); // 0 (Dom) a 6 (Sab)
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para segunda
        const start = new Date(d.setDate(diff));
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        return [start.toISOString().split("T")[0], end.toISOString().split("T")[0]];
      };

      const getMonthRange = () => {
        const d = new Date(selectedDate + "T12:00:00");
        const year = d.getFullYear();
        const month = d.getMonth();
        const start = new Date(year, month, 1);
        const end = new Date(year, month + 1, 0);
        return [start.toISOString().split("T")[0], end.toISOString().split("T")[0]];
      };

      const getDatesInRange = (startDate, endDate) => {
        const dates = [];
        let currentDate = new Date(startDate + "T12:00:00");
        const lastDate = new Date(endDate + "T12:00:00");

        while (currentDate <= lastDate) {
          dates.push(currentDate.toISOString().split("T")[0]);
          currentDate.setDate(currentDate.getDate() + 1);
        }

        return dates;
      };

      // --- CRUD ---
      const handleSaveShift = async () => {
        if (!form.doctorId || !form.roleId) return;

        const doctor = DOCTORS_MOCK.find((d) => d.id === form.doctorId);
        const role = ROLES.find((r) => r.id === form.roleId);
        const timestamp = new Date().toISOString();

        const shiftData = {
          id: selectedShift ? selectedShift.id : `${form.date}-${form.roleId}-${form.doctorId}-${Date.now()}`,
          date: form.date,
          roleId: form.roleId,
          doctorId: form.doctorId,
          status: form.status,
          obs: form.obs,
          history: selectedShift
            ? [...selectedShift.history, { date: timestamp, action: `Editado por ${doctor.name}` }]
            : [{ date: timestamp, action: `Criado por ${doctor.name}` }]
        };

        try {
          await setDoc(doc(db, "artifacts", appId, "public", "data", "shifts", shiftData.id), shiftData);
          setToast({ type: "success", msg: "Escala salva com sucesso!" });
          setIsModalOpen(false);
          setSelectedShift(null);
        } catch (error) {
          console.error("Erro ao salvar:", error);
          setToast({ type: "error", msg: "Erro ao salvar. Verifique permissões." });
        }
      };

      const handleDelete = async (shiftId) => {
        if (!shiftId) return;
        try {
          await deleteDoc(doc(db, "artifacts", appId, "public", "data", "shifts", shiftId));
          setToast({ type: "success", msg: "Escala removida com sucesso!" });
          setIsModalOpen(false);
          setSelectedShift(null);
        } catch (error) {
          console.error("Erro ao remover:", error);
          setToast({ type: "error", msg: "Erro ao remover. Verifique permissões." });
        }
      };

      // --- IMPORT/EXPORT ---
      const handleProcessImport = async (dataOverride = null) => {
        const rawText = dataOverride ?? importText;
        if (!rawText) return;

        const lines = rawText.split("\n").filter(Boolean);

        for (const line of lines) {
          const [date, roleNameRaw, doctorNameRaw] = line.split(",").map((value) => value.trim());
          if (!date || !roleNameRaw || !doctorNameRaw) continue;

          const roleName = roleNameRaw.toLowerCase();
          const doctorName = doctorNameRaw.toLowerCase();

          const role = ROLES.find((r) => r.name.toLowerCase().includes(roleName) || r.id === roleNameRaw.toLowerCase());
          const doctor = DOCTORS_MOCK.find((d) => d.name.toLowerCase().includes(doctorName));

          if (!role || !doctor) continue;

          const shiftData = {
            id: `${date}-${role.id}-${doctor.id}-${Date.now()}`,
            date,
            roleId: role.id,
            doctorId: doctor.id,
            status: "confirmado",
            obs: "",
            history: [{ date: new Date().toISOString(), action: `Importado (${doctor.name})` }]
          };

          try {
            await setDoc(doc(db, "artifacts", appId, "public", "data", "shifts", shiftData.id), shiftData);
          } catch (error) {
            console.error("Erro na importação:", error);
          }
        }

        setToast({ type: "success", msg: "Importação concluída!" });
        setIsImportModalOpen(false);
        setImportText("");
      };

      const handleExport = () => {
        const text = shifts
          .map((s) => {
            const role = ROLES.find((r) => r.id === s.roleId)?.name || s.roleId;
            const doctor = DOCTORS_MOCK.find((d) => d.id === s.doctorId)?.name || s.doctorId;
            return `${s.date},${role},${doctor}`;
          })
          .join("\n");

        navigator.clipboard.writeText(text);
        setToast({ type: "success", msg: "Backup copiado!" });
      };

      // --- AI COPILOT ---
      const handleGenerateAIReport = async (type) => {
        setAiLoading(true);
        setAiResult("");

        try {
          const rolesToday = ROLES.map((r) => {
            const assignedDoctors = shifts.filter((s) => s.date === selectedDate && s.roleId === r.id);
            const names = assignedDoctors
              .map((s) => DOCTORS_MOCK.find((d) => d.id === s.doctorId)?.name)
              .filter(Boolean);
            return `${r.name}: ${names.length ? names.join(", ") : "Sem médico"}`;
          }).join("\n");

          const prompt =
            type === "whatsapp"
              ? `Crie um comunicado curto e direto em português para WhatsApp com a escala do dia ${formatDateBR(selectedDate)}. Use emojis relevantes e destaque qualquer falta.\n\n${rolesToday}`
              : `Audite a escala do dia ${formatDateBR(selectedDate)} verificando se o número mínimo de médicos por turno foi atingido. Liste os turnos incompletos e sugira prioridade.\n\n${rolesToday}`;

          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + GEMINI_API_KEY, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          const data = await response.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Não foi possível gerar a resposta.";
          setAiResult(text);
        } catch (error) {
          console.error("Erro na IA:", error);
          setAiResult("Erro ao gerar resposta. Tente novamente.");
        } finally {
          setAiLoading(false);
        }
      };

      const copyAIResult = () => {
        if (!aiResult) return;
        navigator.clipboard.writeText(aiResult);
        setToast({ type: "success", msg: "Texto copiado!" });
      };

      // --- MEMOIZED RENDERED DATA ---
      const filteredShifts = useMemo(() => {
        if (viewMode === "day") {
          return shifts.filter((s) => s.date === selectedDate);
        }
        if (viewMode === "week") {
          const [start, end] = getWeekRange();
          return shifts.filter((s) => s.date >= start && s.date <= end);
        }
        if (viewMode === "month") {
          const [start, end] = getMonthRange();
          return shifts.filter((s) => s.date >= start && s.date <= end);
        }
        return shifts;
      }, [shifts, viewMode, selectedDate]);

      const shiftsByDate = useMemo(() => {
        return filteredShifts.reduce((acc, shift) => {
          if (!acc[shift.date]) acc[shift.date] = [];
          acc[shift.date].push(shift);
          return acc;
        }, {});
      }, [filteredShifts]);

      // --- COMPONENTS ---
      const ShiftCard = ({ shift }) => {
        const role = ROLES.find((r) => r.id === shift.roleId);
        const doctor = DOCTORS_MOCK.find((d) => d.id === shift.doctorId);

        return (
          <div
            className="bg-white rounded-xl shadow-sm border border-slate-200 px-4 py-3 flex items-center justify-between hover:shadow-md transition-all cursor-pointer"
            onClick={() => {
              setSelectedShift(shift);
              setForm({
                doctorId: shift.doctorId,
                roleId: shift.roleId,
                date: shift.date,
                status: shift.status,
                obs: shift.obs
              });
              setSelectedGroup(role?.groupId || "g_pa_dia");
              setIsModalOpen(true);
            }}
          >
            <div className="flex items-center gap-4">
              <div className={`w-3 h-3 rounded-full ${SHIFT_GROUPS.find((g) => g.id === role?.groupId)?.dotColor}`} />
              <div>
                <div className="font-semibold text-slate-800 text-sm">{doctor?.name}</div>
                <div className="text-xs text-slate-500">{role?.name}</div>
              </div>
            </div>
            <StatusBadge status={shift.status} />
          </div>
        );
      };

      const EmptyState = ({ label }) => (
        <div className="text-xs text-slate-400 text-center py-8">{label}</div>
      );

      const DailyView = () => (
        <div className="space-y-6">
          {SHIFT_GROUPS.map((group) => (
            <div key={group.id} className="space-y-3">
              <div className="flex items-center gap-3">
                <div className={`text-xs font-bold uppercase px-2 py-1 rounded-full border ${group.color}`}>{group.name}</div>
                <span className="text-xs text-slate-500">{group.time}</span>
              </div>
              <div className="space-y-2">
                {filteredShifts.filter((s) => ROLES.find((r) => r.id === s.roleId)?.groupId === group.id).length === 0 ? (
                  <EmptyState label="Nenhum médico alocado." />
                ) : (
                  filteredShifts
                    .filter((s) => ROLES.find((r) => r.id === s.roleId)?.groupId === group.id)
                    .map((shift) => <ShiftCard key={shift.id} shift={shift} />)
                )}
              </div>
            </div>
          ))}
        </div>
      );

      const WeeklyView = () => {
        const [start, end] = getWeekRange();
        const dates = getDatesInRange(start, end);

        return (
          <div className="space-y-6">
            {dates.map((date) => (
              <div key={date} className="space-y-3">
                <div className={`flex items-center gap-2 ${isWeekend(date) ? "text-red-500" : "text-slate-700"}`}>
                  <Calendar size={16} />
                  <span className="text-sm font-bold">{getDayOfWeek(date)}</span>
                  <span className="text-xs">{new Date(date).toLocaleDateString("pt-BR")}</span>
                </div>
                <div className="grid sm:grid-cols-2 gap-3">
                  {(shiftsByDate[date] || []).map((shift) => (
                    <ShiftCard key={shift.id} shift={shift} />
                  ))}
                  {(shiftsByDate[date] || []).length === 0 && <EmptyState label="Nenhum médico alocado." />}
                </div>
              </div>
            ))}
          </div>
        );
      };

      const MonthlyView = () => {
        const [start, end] = getMonthRange();
        const dates = getDatesInRange(start, end);
        const weekdays = ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom"];
        const firstWeekday = new Date(start + "T12:00:00").getDay() || 7; // Ajusta domingo
        const emptyDays = Array.from({ length: firstWeekday - 1 });

        return (
          <div className="space-y-6">
            <div className="grid grid-cols-7 gap-2 text-xs text-center text-slate-400 font-semibold">
              {weekdays.map((day) => (
                <div key={day}>{day}</div>
              ))}
            </div>
            <div className="grid grid-cols-7 gap-2">
              {emptyDays.map((_, idx) => (
                <div key={`empty-${idx}`} />
              ))}
              {dates.map((date) => (
                <div
                  key={date}
                  className={`rounded-lg border p-2 min-h-[110px] text-xs space-y-1 ${date === selectedDate ? "border-emerald-500 bg-emerald-50" : "border-slate-200 bg-white"}`}
                >
                  <div className={`text-[10px] font-bold ${isWeekend(date) ? "text-red-500" : "text-slate-500"}`}>
                    {new Date(date).getDate()}
                  </div>
                  {(shiftsByDate[date] || []).slice(0, 3).map((shift) => {
                    const role = ROLES.find((r) => r.id === shift.roleId);
                    const doctor = DOCTORS_MOCK.find((d) => d.id === shift.doctorId);
                    return (
                      <div
                        key={shift.id}
                        className="text-[10px] truncate flex items-center gap-1"
                        title={`${doctor?.name} - ${role?.name}`}
                      >
                        <span className={`w-1.5 h-1.5 rounded-full ${SHIFT_GROUPS.find((g) => g.id === role?.groupId)?.dotColor}`} />
                        {doctor?.name}
                      </div>
                    );
                  })}
                  {(shiftsByDate[date] || []).length > 3 && (
                    <div className="text-[9px] text-slate-400">+{(shiftsByDate[date] || []).length - 3} mais</div>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      const handleOpenNewShift = () => {
        setSelectedShift(null);
        setForm({ doctorId: "", roleId: "pa_dia", date: selectedDate, status: "confirmado", obs: "" });
        setSelectedGroup("g_pa_dia");
        setIsModalOpen(true);
      };

      return (
        <div className="min-h-screen flex flex-col">
          {/* HEADER */}
          <header className="bg-white shadow-sm border-b border-slate-200">
            <div className="max-w-7xl mx-auto px-4 py-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                  <LayoutGrid className="text-emerald-600" /> Gift Hub Pages
                </h1>
                <p className="text-sm text-slate-500">Gestor de Escalas Médicas</p>
              </div>
              <div className="flex flex-wrap items-center gap-3">
                <button
                  onClick={() => setIsImportModalOpen(true)}
                  className="px-4 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium flex items-center gap-2"
                >
                  <UploadCloud size={16} /> Importar/Exportar
                </button>
                <button
                  onClick={() => setIsCopilotOpen(true)}
                  className="px-4 py-2 rounded-lg border border-purple-200 bg-purple-50 hover:bg-purple-100 text-purple-700 text-sm font-semibold flex items-center gap-2"
                >
                  <Sparkles size={16} /> Copiloto IA
                </button>
                <button
                  onClick={handleOpenNewShift}
                  className="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold flex items-center gap-2 shadow-sm"
                >
                  <Plus size={16} /> Novo Médico
                </button>
              </div>
            </div>
          </header>

          {/* STATUS BAR */}
          <div className="bg-white border-b border-slate-200">
            <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => handleNav("prev")}
                  className="w-9 h-9 rounded-lg border border-slate-200 flex items-center justify-center hover:bg-slate-50"
                >
                  <ChevronLeft size={18} />
                </button>
                <div className="text-sm font-semibold text-slate-800">
                  {viewMode === "day" && new Date(selectedDate).toLocaleDateString("pt-BR", { weekday: "long", day: "2-digit", month: "long" })}
                  {viewMode === "week" &&
                    (() => {
                      const [start, end] = getWeekRange();
                      return `${new Date(start).toLocaleDateString("pt-BR", { day: "2-digit", month: "short" })} - ${new Date(end).toLocaleDateString("pt-BR", { day: "2-digit", month: "short" })}`;
                    })()}
                  {viewMode === "month" && new Date(selectedDate).toLocaleDateString("pt-BR", { month: "long", year: "numeric" })}
                </div>
                <button
                  onClick={() => handleNav("next")}
                  className="w-9 h-9 rounded-lg border border-slate-200 flex items-center justify-center hover:bg-slate-50"
                >
                  <ChevronRight size={18} />
                </button>
              </div>

              <div className="flex flex-wrap items-center gap-2">
                <button
                  onClick={() => setViewMode("day")}
                  className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase border ${viewMode === "day" ? "bg-emerald-600 border-emerald-600 text-white" : "border-slate-200 text-slate-500 hover:bg-slate-50"}`}
                >
                  <CalendarDays size={14} className="inline mr-1" /> Dia
                </button>
                <button
                  onClick={() => setViewMode("week")}
                  className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase border ${viewMode === "week" ? "bg-emerald-600 border-emerald-600 text-white" : "border-slate-200 text-slate-500 hover:bg-slate-50"}`}
                >
                  <LayoutGrid size={14} className="inline mr-1" /> Semana
                </button>
                <button
                  onClick={() => setViewMode("month")}
                  className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase border ${viewMode === "month" ? "bg-emerald-600 border-emerald-600 text-white" : "border-slate-200 text-slate-500 hover:bg-slate-50"}`}
                >
                  <Calendar size={14} className="inline mr-1" /> Mês
                </button>
              </div>

              <div className="flex items-center gap-2 text-xs text-slate-500">
                {isOnline ? (
                  <span className="flex items-center gap-1">
                    <Wifi size={14} /> Online
                  </span>
                ) : (
                  <span className="flex items-center gap-1">
                    <WifiOff size={14} /> Offline
                  </span>
                )}
              </div>
            </div>
          </div>

          {/* AVISO DE CONFIGURAÇÃO */}
          {authError === "permissao" && (
            <div className="bg-red-600 text-white text-center p-3 text-sm font-bold flex flex-col items-center justify-center gap-1 animate-in slide-in-from-top-10">
              <div className="flex items-center gap-2">
                <ShieldAlert size={20} />
                <span>ATENÇÃO: Configuração do Firebase Incompleta</span>
              </div>
              <p className="text-xs font-normal opacity-90 max-w-2xl">
                Permissão negada para escrita. Vá em Firestore Database &gt; Regras e mude para "allow write: if true;".
              </p>
            </div>
          )}

          {/* AVISO DE MODO BYPASS */}
          {isAuthBypassed && !authError && (
            <div className="bg-amber-500 text-white text-center p-1 text-[10px] font-bold flex items-center justify-center gap-2">
              <Unlock size={12} />
              <span>Modo Público Ativo: Domínio não autorizado no Firebase Auth, mas a conexão ao banco está liberada.</span>
            </div>
          )}

          {/* MAIN */}
          <main className="flex-1 max-w-7xl w-full mx-auto px-4 py-6">
            {viewMode === "day" && <DailyView />}
            {viewMode === "week" && <WeeklyView />}
            {viewMode === "month" && <MonthlyView />}

            {/* LOG */}
            {viewMode !== "month" && (
              <div className="mt-12 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <FileText size={20} className="text-slate-400" />
                  Auditoria de Alterações (Log)
                </h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left">
                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                      <tr>
                        <th className="px-4 py-3">Data/Hora</th>
                        <th className="px-4 py-3">Data Escala</th>
                        <th className="px-4 py-3">Turno</th>
                        <th className="px-4 py-3">Ação</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {shifts
                        .flatMap((s) => s.history.map((h) => ({ ...h, shiftDate: s.date, role: ROLES.find((r) => r.id === s.roleId)?.name })))
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5)
                        .map((log, idx) => (
                          <tr key={idx} className="hover:bg-slate-50">
                            <td className="px-4 py-3 text-slate-500">{new Date(log.date).toLocaleString("pt-BR")}</td>
                            <td className="px-4 py-3 font-medium text-slate-700">{new Date(log.shiftDate).toLocaleDateString("pt-BR")}</td>
                            <td className="px-4 py-3 text-slate-600">{log.role}</td>
                            <td className="px-4 py-3 text-slate-800">{log.action}</td>
                          </tr>
                        ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </main>

          {/* MODAL EDIÇÃO */}
          {isModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-md animate-in zoom-in-95 duration-200 overflow-hidden flex flex-col max-h-[90vh]">
                <div className="bg-slate-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                  <h3 className="font-bold text-lg">{selectedShift ? "Gerenciar Escala" : "Adicionar Médico"}</h3>
                  <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-white">
                    <X size={20} />
                  </button>
                </div>

                <div className="p-6 space-y-4 overflow-y-auto">
                  <div className="flex bg-slate-100 p-1 rounded-lg mb-2">
                    {SHIFT_GROUPS.map((g) => (
                      <button
                        key={g.id}
                        onClick={() => {
                          setSelectedGroup(g.id);
                          const firstRole = ROLES.find((r) => r.groupId === g.id)?.id;
                          setForm({ ...form, roleId: firstRole });
                        }}
                        className={`flex-1 py-2 text-xs font-bold uppercase rounded-md transition-all ${
                          selectedGroup === g.id ? "bg-white text-emerald-600 shadow-sm" : "text-slate-500 hover:text-slate-700"
                        }`}
                      >
                        {g.name.split(" - ")[0].replace("Horizontal (Internação)", "Rotina")}
                      </button>
                    ))}
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Selecione o Horário</label>
                    <div className="grid grid-cols-1 gap-2">
                      {ROLES.filter((r) => r.groupId === selectedGroup).map((role) => (
                        <label
                          key={role.id}
                          className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${
                            form.roleId === role.id ? "border-emerald-500 bg-emerald-50 ring-1 ring-emerald-500" : "border-slate-200 hover:bg-slate-50"
                          }`}
                        >
                          <input
                            type="radio"
                            name="role"
                            value={role.id}
                            checked={form.roleId === role.id}
                            onChange={() => setForm({ ...form, roleId: role.id })}
                            className="hidden"
                          />
                          <div className="flex-1">
                            <div className="font-medium text-sm text-slate-800">{role.name}</div>
                            <div className="text-xs text-slate-500">{role.time}</div>
                          </div>
                          {form.roleId === role.id && <CheckCircle2 size={16} className="text-emerald-600" />}
                        </label>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Médico</label>
                    <div className="relative">
                      <select
                        value={form.doctorId}
                        onChange={(e) => setForm({ ...form, doctorId: e.target.value })}
                        className="w-full border border-slate-300 rounded-lg px-4 py-2.5 text-slate-800 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none bg-white"
                      >
                        <option value="">Selecione...</option>
                        {DOCTORS_MOCK.map((d) => (
                          <option key={d.id} value={d.id}>
                            {d.name} {d.allowedHorizontal ? "★" : ""}
                          </option>
                        ))}
                      </select>
                      <Search className="absolute right-3 top-3 text-slate-400 pointer-events-none" size={16} />
                    </div>
                    {selectedGroup === "g_horizontal" && <p className="text-[10px] text-slate-400 mt-1">★ = Autorizado para Rotina/Horizontal</p>}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                      <select
                        value={form.status}
                        onChange={(e) => setForm({ ...form, status: e.target.value })}
                        className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 outline-none focus:border-emerald-500"
                      >
                        <option value="confirmado">Confirmado</option>
                        <option value="pendente">A Confirmar</option>
                        <option value="troca">Troca Realizada</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Data</label>
                      <input
                        type="date"
                        value={form.date}
                        onChange={(e) => setForm({ ...form, date: e.target.value })}
                        className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 outline-none focus:border-emerald-500"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Obs (Opcional)</label>
                    <textarea
                      value={form.obs}
                      onChange={(e) => setForm({ ...form, obs: e.target.value })}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 outline-none focus:border-emerald-500 h-16 resize-none"
                    />
                  </div>

                  <div className="flex gap-3 pt-2">
                    {selectedShift && (
                      <button onClick={() => handleDelete(selectedShift.id)} className="px-4 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                        <Trash2 size={20} />
                      </button>
                    )}
                    <button
                      onClick={handleSaveShift}
                      className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-lg shadow-sm transition-all active:scale-95 flex items-center justify-center gap-2"
                    >
                      <Save size={18} /> {selectedShift ? "Salvar Alterações" : "Confirmar"}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL IMPORT/EXPORT */}
          {isImportModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-in zoom-in-95 duration-200 overflow-hidden flex flex-col max-h-[90vh]">
                <div className="bg-slate-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <UploadCloud size={20} />
                    Importar / Exportar
                  </h3>
                  <button onClick={() => setIsImportModalOpen(false)} className="text-slate-400 hover:text-white">
                    <X size={20} />
                  </button>
                </div>
                <div className="p-6 space-y-4">
                  {/* AREA ESPECIAL DE IMPORTACAO DEZEMBRO */}
                  <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex flex-col gap-2">
                    <div className="flex items-center gap-2 text-emerald-800 font-bold">
                      <Database size={20} />
                      <h4>Carga Rápida</h4>
                    </div>
                    <p className="text-xs text-emerald-700">Detectamos uma escala pré-configurada para Dezembro 2025.</p>
                    <button
                      onClick={() => handleProcessImport(DECEMBER_DATA_RAW)}
                      className="bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95"
                    >
                      Carregar Escala Dez. 2025
                    </button>
                  </div>

                  <hr className="border-slate-100" />

                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                    <p className="font-bold mb-1">Importação Manual:</p>
                    <p>Copie os dados do seu Excel e cole abaixo no formato:</p>
                    <code className="block bg-white border border-blue-200 p-2 mt-1 rounded text-xs font-mono">
                      2024-12-01,Diurno,Dr. Wellington<br />
                      2024-12-01,Noturno,Dra. Ana
                    </code>
                  </div>
                  <textarea
                    value={importText}
                    onChange={(e) => setImportText(e.target.value)}
                    placeholder="Cole seus dados CSV ou JSON aqui..."
                    className="w-full h-32 border border-slate-300 rounded-lg p-3 text-xs font-mono focus:border-emerald-500 outline-none"
                  />
                  <div className="flex gap-3">
                    <button
                      onClick={handleExport}
                      className="flex-1 px-4 py-2 border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-lg flex items-center justify-center gap-2 font-medium"
                    >
                      <DownloadCloud size={16} /> Copiar Backup
                    </button>
                    <button
                      onClick={() => handleProcessImport(null)}
                      className="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg flex items-center justify-center gap-2 font-medium shadow-sm"
                    >
                      <FileSpreadsheet size={16} /> Processar Manual
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL COPILOTO IA */}
          {isCopilotOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-in zoom-in-95 duration-200 overflow-hidden flex flex-col max-h-[90vh]">
                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center text-white shrink-0">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Sparkles size={20} />
                    Copiloto IA
                  </h3>
                  <button onClick={() => setIsCopilotOpen(false)} className="text-white/80 hover:text-white">
                    <X size={20} />
                  </button>
                </div>
                <div className="p-6 flex flex-col h-full overflow-hidden">
                  {!aiResult ? (
                    <div className="space-y-4">
                      <p className="text-sm text-slate-600">
                        Selecione uma ação para o dia <span className="font-bold">{formatDateBR(selectedDate)}</span>:
                      </p>

                      <button
                        onClick={() => handleGenerateAIReport("whatsapp")}
                        disabled={aiLoading}
                        className="w-full p-4 border border-green-200 bg-green-50 hover:bg-green-100 rounded-xl flex items-center gap-4 transition-all group text-left"
                      >
                        <div className="bg-green-500 p-3 rounded-full text-white shadow-sm group-hover:scale-110 transition-transform">
                          <MessageSquare size={24} />
                        </div>
                        <div>
                          <h4 className="font-bold text-slate-800">Gerar Comunicado WhatsApp</h4>
                          <p className="text-xs text-slate-500 mt-1">Cria o texto formatado da escala do dia com emojis pronto para enviar.</p>
                        </div>
                      </button>

                      <button
                        onClick={() => handleGenerateAIReport("audit")}
                        disabled={aiLoading}
                        className="w-full p-4 border border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-xl flex items-center gap-4 transition-all group text-left"
                      >
                        <div className="bg-blue-500 p-3 rounded-full text-white shadow-sm group-hover:scale-110 transition-transform">
                          <CheckCircle2 size={24} />
                        </div>
                        <div>
                          <h4 className="font-bold text-slate-800">Auditar Escala (Faltas)</h4>
                          <p className="text-xs text-slate-500 mt-1">Verifica se as metas de médicos foram batidas e sugere prioridades.</p>
                        </div>
                      </button>

                      {aiLoading && (
                        <div className="flex flex-col items-center justify-center py-8 text-slate-500 gap-2">
                          <Loader2 size={32} className="animate-spin text-purple-600" />
                          <span className="text-xs font-medium">A inteligência artificial está analisando a escala...</span>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="flex flex-col h-full">
                      <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-700 whitespace-pre-wrap flex-1 overflow-y-auto font-mono mb-4 shadow-inner">
                        {aiResult}
                      </div>
                      <div className="flex gap-3">
                        <button onClick={() => setAiResult("")} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-medium">
                          Voltar
                        </button>
                        <button
                          onClick={copyAIResult}
                          className="flex-[2] bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold shadow-sm flex items-center justify-center gap-2"
                        >
                          <Copy size={16} /> Copiar Texto
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* TOAST */}
          {toast && (
            <div
              className={`fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg border flex items-center gap-3 z-50 animate-in slide-in-from-bottom-5 fade-in duration-300 ${
                toast.type === "success" ? "bg-white border-green-200 text-green-700" : "bg-white border-red-200 text-red-700"
              }`}
            >
              {toast.type === "success" ? <CheckCircle2 size={18} /> : <AlertCircle size={18} />}
              <span className="text-sm font-medium">{toast.msg}</span>
            </div>
          )}

          <style>{`
            .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
          `}</style>
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<MedicalScaleManager />);
  </script>
</body>
</html>
